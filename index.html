<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìŠ¬ë¡¯ë¨¸ì‹ </title>
<style>
  :root{
    --bg1:#0b1020;
    --bg2:#25163a;
    --neon1:#ff3d81;
    --neon2:#00e5ff;
    --panel:#0e0f1a;
    --accent:#ffd166;
  }
  html,body{
    height:100%;
    margin:0;
    font-family: "Noto Sans KR", Arial, sans-serif;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#fff;
    -webkit-font-smoothing:antialiased;
  }

  /* Slot-machine style striped background */
  .bg-stripes {
    position:fixed;
    inset:0;
    background-image:
      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px),
      linear-gradient(45deg, rgba(255,255,255,0.01) 1px, transparent 1px);
    background-size: 6px 6px, 40px 40px;
    z-index:0;
  }

  .container{
    position:relative;
    z-index:1;
    max-width:900px;
    margin:40px auto;
    padding:20px;
    text-align:center;
  }

  h1{
    margin:8px 0 16px;
    font-size:28px;
    letter-spacing:1px;
    color:var(--accent);
    text-shadow:0 0 12px rgba(255,209,102,0.12);
  }

  /* Slot cabinet */
  .machine {
    margin:0 auto;
    width:640px;
    max-width:95%;
    background: linear-gradient(180deg,#1b1228,#0f0b14);
    border-radius:16px;
    padding:22px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 30px rgba(0,0,0,0.4) inset;
    border:4px solid rgba(255,255,255,0.03);
  }

  .reels {
    display:flex;
    justify-content:space-between;
    gap:18px;
    padding:20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius:12px;
  }

  .reel {
    flex:1;
    background:linear-gradient(180deg,#0e1420,#061018);
    border-radius:10px;
    padding:16px;
    height:160px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:48px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    color:#fff;
    letter-spacing:6px;
    user-select:none;
  }

  .controls{
    margin-top:18px;
    display:flex;
    gap:10px;
    justify-content:center;
    align-items:center;
    flex-wrap:wrap;
  }

  button {
    padding:10px 16px;
    border-radius:8px;
    border:0;
    background:linear-gradient(90deg,var(--neon1),var(--neon2));
    color:#081225;
    font-weight:700;
    cursor:pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.4);
  }

  button.secondary{
    background:linear-gradient(90deg,#44485a,#2a2e3a);
    color:#fff;
  }

  .status{
    color:#ddd;
    font-size:14px;
    margin-left:8px;
  }

  .play-count{
    margin-top:12px;
    color:#ffd;
  }

  /* modal overlay */
  .overlay {
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.75));
    z-index:10;
  }
  .overlay.active{ display:flex; }

  .modal {
    width:380px;
    max-width:90%;
    background:linear-gradient(180deg,#111018,#171423);
    border-radius:12px;
    padding:18px;
    text-align:center;
    box-shadow:0 12px 40px rgba(0,0,0,0.7);
    border:1px solid rgba(255,255,255,0.03);
  }

  .modal h2{ margin:0 0 8px; color:#ffb3b3; }
  .modal p{ margin:0 0 12px; color:#ffdede; font-size:14px; }

  input[type="password"]{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:0;
    margin-bottom:10px;
    box-sizing:border-box;
    font-size:16px;
  }

  .note{
    margin-top:10px;
    font-size:12px;
    color:#cfcfcf;
  }

  footer{
    margin-top:18px;
    font-size:13px;
    color:#cfcfcf;
  }

  /* small screens tweak */
  @media (max-width:640px){
    .reel{ font-size:36px; height:120px; }
    .machine{ padding:14px; }
  }
</style>
</head>
<body>
  <div class="bg-stripes"></div>

  <div class="container">
    <h1>ìŠ¬ë¡¯ë¨¸ì‹ </h1>

    <div class="machine" role="application" aria-label="slot machine">
      <div class="reels" id="reels">
        <div class="reel" id="r1">ğŸ’</div>
        <div class="reel" id="r2">ğŸ‹</div>
        <div class="reel" id="r3">ğŸŠ</div>
      </div>

      <div class="controls">
        <button id="connectBtn">Arduino ì—°ê²°</button>
        <button id="spinBtn">Spin</button>
        <button id="unlockBtn" class="secondary" style="display:none">ì ê¸ˆ í•´ì œ</button>
        <div class="status" id="status">ìƒíƒœ: ë¯¸ì—°ê²°</div>
      </div>

      <div class="play-count" id="playCount">í”Œë ˆì´ íšŸìˆ˜: 0</div>

    </div>
  </div>

  <!-- modal: ê²½ê³  + ë¹„ë°€ë²ˆí˜¸ -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h2>ë„ë°•ì€ ìœ„í—˜í•©ë‹ˆë‹¤</h2>
      <p>3ë²ˆ í”Œë ˆì´í•˜ì…¨ìŠµë‹ˆë‹¤. ê³„ì†í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input id="pwdInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <div style="display:flex; gap:8px;">
        <button id="pwdOk">í™•ì¸</button>
        <button id="pwdCancel" class="secondary">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

<script>
/*
  slot.html
  - Web Serial APIë¡œ ì•„ë‘ì´ë…¸ì™€ í†µì‹  (ì½ê¸° ì „ìš© ì˜ˆ)
  - ì•„ë‘ì´ë…¸ê°€ "pressed" ë¼ì¸ì„ ì „ì†¡í•˜ë©´ startSlotMachine() í˜¸ì¶œ
  - 3ë²ˆ í”Œë ˆì´ ì´í›„ ì ê¸ˆ -> ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ìš”
  - ê¸°ë³¸ íŒ¨ìŠ¤ì›Œë“œ: 1234 (ì•„ë˜ PASSWORD ë³€ìˆ˜ ìˆ˜ì •í•´ì„œ ë°”ê¿€ ê²ƒ)
*/

/* ========== ì„¤ì • ========== */
const BAUD_RATE = 9600;
const PASSWORD = "1336"; // <--- ì—¬ê¸°ì„œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ì„¸ìš”
const MAX_PLAYS_BEFORE_LOCK = 3;

/* ========== UI ìš”ì†Œ ========== */
const connectBtn = document.getElementById('connectBtn');
const spinBtn = document.getElementById('spinBtn');
const unlockBtn = document.getElementById('unlockBtn');
const statusEl = document.getElementById('status');
const playCountEl = document.getElementById('playCount');
const overlay = document.getElementById('overlay');
const pwdInput = document.getElementById('pwdInput');
const pwdOk = document.getElementById('pwdOk');
const pwdCancel = document.getElementById('pwdCancel');

const reels = [
  document.getElementById('r1'),
  document.getElementById('r2'),
  document.getElementById('r3')
];

let playCount = 0;
let locked = false;

/* ========== Serial ê´€ë ¨ ë³€ìˆ˜ ========== */
let port = null;
let reader = null;
let keepReading = false;

/* ========== ìŠ¬ë¡¯ë¨¸ì‹  ì‹¬ë³¼ & ë¡œì§ ========== */
const SYMBOLS = ["ğŸ’","ğŸ‹","ğŸŠ","ğŸ‰","â­","ğŸ””","7ï¸âƒ£","ğŸ‡"];

function randSymbol(){ return SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]; }

function updatePlayCount(){
  playCountEl.textContent = `í”Œë ˆì´ íšŸìˆ˜: ${playCount}`;
  if(playCount >= MAX_PLAYS_BEFORE_LOCK){
    locked = true;
    unlockBtn.style.display = 'inline-block';
  }
}

/* ìŠ¬ë¡¯ ì• ë‹ˆë©”ì´ì…˜: ê° ë¦´ì„ ì¼ì • ì‹œê°„ ëœë¤ìœ¼ë¡œ ë°”ê¾¼ ë’¤ ì •ì§€ */
function startSlotMachine(){
  if(locked){
    // ë½ ìƒíƒœë©´ ì˜¤ë²„ë ˆì´ ë„ìš°ê¸°
    showLockModal();
    return;
  }

  // Disable buttons briefly to prevent ì¤‘ë³µ í˜¸ì¶œ
  spinBtn.disabled = true;
  connectBtn.disabled = true;

  // spin animation
  const durations = [900, 1200, 1500]; // ê° ë¦´ì˜ íšŒì „ ì‹œê°„ (ms)
  const intervals = [];

  for(let i=0;i<3;i++){
    let t = 0;
    intervals[i] = setInterval(()=>{
      reels[i].textContent = randSymbol();
      t += 80;
    }, 80);
  }

  // ì •ì§€ íƒ€ì´ë¨¸ ì„¤ì •
  for(let i=0;i<3;i++){
    setTimeout(()=>{
      clearInterval(intervals[i]);
      // ìµœì¢… ì‹¬ë³¼ ëœë¤ ì§€ì •
      reels[i].textContent = randSymbol();
      // ë§ˆì§€ë§‰ ë¦´ì´ë©´ í’€ê¸°
      if(i===2){
        spinBtn.disabled = false;
        connectBtn.disabled = false;
        playCount++;
        updatePlayCount();
        if(locked) showLockModal();
      }
    }, durations[i]);
  }
}

/* ========== Lock modal control ========== */
function showLockModal(){
  overlay.classList.add('active');
  pwdInput.value = '';
  pwdInput.focus();
}

function hideLockModal(){
  overlay.classList.remove('active');
}

/* unlock flow */
pwdOk.addEventListener('click', ()=>{
  const v = pwdInput.value;
  if(v === PASSWORD){
    // unlock: reset playCount and locked
    playCount = 0;
    locked = false;
    updatePlayCount();
    hideLockModal();
    alert('ì ê¸ˆ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì•ˆì „í•œ ì´ìš© ë¶€íƒë“œë¦½ë‹ˆë‹¤.');
  } else {
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
  }
});

pwdCancel.addEventListener('click', ()=>{
  hideLockModal();
});

/* unlockBtn (í™”ë©´ì˜ ì ê¸ˆí•´ì œ ë²„íŠ¼) */
unlockBtn.addEventListener('click', showLockModal);

/* ========== Web Serial API ì—°ê²° ========== */
async function connectSerial(){
  if(!('serial' in navigator)){
    statusEl.textContent = 'ìƒíƒœ: Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.';
    return;
  }

  try {
    // í¬íŠ¸ ìš”ì²­
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: BAUD_RATE });
    statusEl.textContent = `ìƒíƒœ: ì—°ê²°ë¨ (baud ${BAUD_RATE})`;
    connectBtn.textContent = 'ì—°ê²° í•´ì œ';
    keepReading = true;

    // TextDecoderStreamìœ¼ë¡œ ì½ê¸°
    const decoder = new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();

    readLoop();
  } catch (err) {
    console.error('ì‹œë¦¬ì–¼ ì—°ê²° ì‹¤íŒ¨:', err);
    statusEl.textContent = 'ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨';
  }
}

async function disconnectSerial(){
  keepReading = false;
  try {
    if(reader){
      await reader.cancel();
      reader.releaseLock();
      reader = null;
    }
    if(port){
      await port.close();
      port = null;
    }
    statusEl.textContent = 'ìƒíƒœ: ì—°ê²° í•´ì œë¨';
    connectBtn.textContent = 'Arduino ì—°ê²°';
  } catch(err){
    console.error('ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜:', err);
  }
}

async function readLoop(){
  try {
    while(keepReading && reader){
      const { value, done } = await reader.read();
      if(done) break;
      if(value){
        // valueëŠ” ì‹œë¦¬ì–¼ë¡œ ë“¤ì–´ì˜¨ í…ìŠ¤íŠ¸ (ì¤„ë°”ê¿ˆ í¬í•¨ ê°€ëŠ¥)
        console.log('recv:', value);
        // ê°„ë‹¨ íŒŒì‹±: "pressed" í¬í•¨ë˜ë©´ ìŠ¤í•€
        const cleanValue = value.trim().toLowerCase();
        if(cleanValue == "1"){
          console.log("ì•„ë‘ì´ë…¸ ì‹ í˜¸ ê°ì§€ë¨ â†’ ìŠ¬ë¡¯ë¨¸ì‹  ì‘ë™");
          setTimeout(() => {
            startSlotMachine();
          }, 0); 
          
        }
      }
    }
  } catch(err){
    console.error('readLoop error:', err);
    statusEl.textContent = 'ìƒíƒœ: ì½ê¸° ì˜¤ë¥˜';
  }
}

/* connectBtn í† ê¸€ */
connectBtn.addEventListener('click', async ()=>{
  if(port){
    await disconnectSerial();
  } else {
    await connectSerial();
  }
});

/* spin test button (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©) */
spinBtn.addEventListener('click', ()=>{
  startSlotMachine();
});

/* init */
updatePlayCount();

/* ì•ˆì „ ë©”ì„¸ì§€: í˜ì´ì§€ë¥¼ ë°”ë¡œ ë‹«ì§€ ëª»í•˜ê²Œ í•˜ëŠ” ê°„ë‹¨í•œ ì•ˆë‚´ */
window.addEventListener('beforeunload', (e) => {
  // ì‚¬ìš©ì í™•ì¸ ëŒ€í™”ìƒì ë…¸ì¶œì€ ë¸Œë¼ìš°ì € ì •ì±…ì— ë”°ë¼ ë‹¤ë¦„
  // e.preventDefault();
});
</script>
</body>
</html>
